<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" href="icon.png">
<meta name="theme-color" content="#f2f2f2">
<link rel="apple-touch-icon" href="icon.png">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">

<style>
body { font-family: 'Montserrat', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; background:#f2f2f2; margin:0; padding:8px; }
.app { max-width:360px; margin:0 auto; }

/* HEADER */
.header {
  display:flex; justify-content:space-between; align-items:center;
  background:#fff; padding:12px; border-radius:10px;
  margin-bottom:12px; box-shadow:0 1px 3px rgba(0,0,0,.08);
}

.header-left { display:flex; gap:8px; align-items:center; }

.add-btn {
  width:40px; height:40px; border-radius:50%;
  background:#4caf50; color:#fff; border:none;
  font-size:24px; font-weight:bold; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  box-shadow:0 2px 4px rgba(0,0,0,.2);
}
.add-btn:hover { background:#45a049; }

.actions { display:flex; gap:8px; align-items:center; }

.avatar { width:32px; height:32px; border-radius:50%; }

.btn {
  padding:6px 14px; font-size:13px;
  border-radius:6px; border:1px solid #bbb;
  background:#fff; cursor:pointer;
  font-family: 'Montserrat', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
}
.btn.edit-on { background:#ffecb3; border-color:#ff9800; }

/* CARDS */
.card {
  background:#fff; border-radius:8px; padding:8px;
  margin-bottom:8px; border:2px solid transparent;
  box-shadow:0 1px 3px rgba(0,0,0,.08);
  --card-bg: #fff;
}

.name { 
  font-family: 'Montserrat', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; 
  font-weight:700; 
  margin-bottom:4px; 
  font-size:16px; 
}

.card-header { 
  display:flex; 
  justify-content:space-between; 
  align-items:center; 
  margin-bottom:6px; 
}

.plate-right { 
  font-family: 'Montserrat', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; 
  font-weight:800; 
  color:#222; 
  font-size:16px; 
}

.meta { 
  display:flex; 
  gap:6px; 
  flex-wrap:wrap; 
  align-items:center; 
}

.meta > div { min-width:110px; }

.meta-entry { 
  background:transparent; 
  padding:4px 6px 1px 6px; 
  border-radius:6px; 
  min-width:110px; 
  border-left:3px solid rgba(0,0,0,0.04); 
  display:flex; 
  flex-direction:column; 
  position:relative; 
  overflow:hidden; 
}

.meta-label { 
  font-size:11px; 
  color:#666; 
  line-height:1; 
}

.meta-value { 
  font-weight:700; 
  color:#222; 
  margin-top:1px; 
  font-size:13px; 
  line-height:1; 
}

/* overlay for flash animation */
.meta-entry::before { 
  content:""; 
  position:absolute; 
  inset:0; 
  background:transparent; 
  z-index:0; 
  pointer-events:none; 
}

.meta-entry .meta-label, 
.meta-entry .meta-value { 
  position:relative; 
  z-index:1; 
}

.meta-entry.warn::before, 
.meta-entry.expired::before { 
  animation: flash-red 1.2s infinite; 
}

.row { 
  display:flex; 
  gap:64px; 
  align-items:center; 
}

img.vehicle { 
  width:110px; 
  max-width:40%; 
  height:auto; 
  flex-shrink:0; 
  object-fit:contain; 
  margin-right:14px; 
}

.info { 
  font-size:12px; 
  color:#555; 
  line-height:1.3; 
}

.info div { margin-bottom:4px; }

.updated { 
  font-size:11px; 
  color:#777; 
  margin-top:4px; 
}

input.date { 
  width:100%; 
  font-size:11px; 
  padding:2px; 
}

.warn { color:#ff9800; }
.expired { color:#e53935; font-weight:600; }

/* MODAL */
.modal-overlay {
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.5); z-index:1000;
  align-items:center; justify-content:center;
}
.modal-overlay.active { display:flex; }

.modal {
  background:#fff; border-radius:12px;
  padding:20px; max-width:320px; width:90%;
  box-shadow:0 4px 12px rgba(0,0,0,.3);
}

.modal h2 {
  margin:0 0 16px 0; font-size:18px;
  font-weight:700; color:#222;
}

.modal label {
  display:block; font-size:13px;
  color:#666; margin-bottom:4px;
}

.modal input, .modal select {
  width:100%; padding:8px; font-size:14px;
  border:1px solid #ccc; border-radius:6px;
  margin-bottom:12px; box-sizing:border-box;
  font-family: 'Montserrat', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
}

.modal-buttons {
  display:flex; gap:8px; justify-content:flex-end;
}

.modal-btn {
  padding:8px 16px; font-size:13px;
  border-radius:6px; cursor:pointer; border:none;
  font-family: 'Montserrat', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
  font-weight:600;
}

.modal-btn.cancel {
  background:#eee; color:#666;
}
.modal-btn.cancel:hover { background:#ddd; }

.modal-btn.confirm {
  background:#4caf50; color:#fff;
}
.modal-btn.confirm:hover { background:#45a049; }

@keyframes flash-red {
  0%{background:transparent; box-shadow:none}
  50%{background:linear-gradient(90deg, rgba(229,57,53,0.16) 0%, var(--card-bg, #fff) 85%); box-shadow:0 0 8px rgba(0,0,0,0.04)}
  100%{background:transparent; box-shadow:none}
}

.loading {
  text-align: center;
  padding: 20px;
  color: #666;
}
</style>
</head>

<body>

<div class="app">

<div class="header">
  <div class="header-left">
    <button class="add-btn" onclick="openAddVehicleModal()" title="Add Vehicle">+</button>
  </div>
  <div class="actions">
    <img id="avatar" class="avatar">
    <button id="loginBtn" class="btn" onclick="signIn()">Login</button>
    <button id="logoutBtn" class="btn" onclick="signOut()">Logout</button>
  </div>
</div>

<div id="vehicles" class="loading">Loading vehicles...</div>

<!-- Add Vehicle Modal -->
<div class="modal-overlay" id="addVehicleModal">
  <div class="modal">
    <h2>Add New Vehicle</h2>
    <label>Vehicle Name</label>
    <input type="text" id="vehicleName" placeholder="e.g., Honda PCX">
    <label>Plate</label>
    <input type="text" id="vehiclePlate" placeholder="e.g., 1กต 8316">
    <label>Vehicle Type</label>
    <select id="vehicleType">
      <option value="advbike">ADVBike</option>
      <option value="dirtbike">Dirtbike</option>
      <option value="motorcycle">Motorcycle</option>
      <option value="pickup">Pickup</option>
      <option value="scooter" selected>Scooter</option>
      <option value="sedan">Sedan</option>
      <option value="van">Van</option>
    </select>
    <label>Tax Expiry (DD/MM/YY)</label>
    <input type="text" id="addTaxExpiry" placeholder="e.g., 31/12/26">
    <label>Insurance Expiry (DD/MM/YY)</label>
    <input type="text" id="addInsuranceExpiry" placeholder="e.g., 31/12/26">
    <div class="modal-buttons">
      <button class="modal-btn cancel" onclick="closeAddVehicleModal()">Cancel</button>
      <button class="modal-btn confirm" onclick="addVehicle()">Add Vehicle</button>
    </div>
  </div>
</div>

<!-- Edit Vehicle Modal -->
<div class="modal-overlay" id="editVehicleModal">
  <div class="modal">
    <h2>Edit Vehicle</h2>
    <label>Vehicle Name</label>
    <input type="text" id="editVehicleName">
    <label>Plate</label>
    <input type="text" id="editVehiclePlate">
    <label>Vehicle Type</label>
    <select id="editVehicleType">
      <option value="advbike">ADVBike</option>
      <option value="dirtbike">Dirtbike</option>
      <option value="motorcycle">Motorcycle</option>
      <option value="pickup">Pickup</option>
      <option value="scooter">Scooter</option>
      <option value="sedan">Sedan</option>
      <option value="van">Van</option>
    </select>
    <label>Tax Expiry (DD/MM/YY)</label>
    <input type="text" id="editTaxExpiry">
    <label>Insurance Expiry (DD/MM/YY)</label>
    <input type="text" id="editInsuranceExpiry">
    <div class="modal-buttons">
      <button class="modal-btn cancel" onclick="closeEditVehicleModal()">Cancel</button>
      <button class="modal-btn" style="background:#e53935; color:#fff" onclick="deleteVehicle()">Delete</button>
      <button class="modal-btn confirm" onclick="saveEditVehicle()">Save</button>
    </div>
  </div>
</div>

</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyBVPmWjildPOT-JnBxFUY8M90c20y0NF2s",
  authDomain: "vehiclecheckapp-3ca0e.firebaseapp.com",
  projectId: "vehiclecheckapp-3ca0e",
  storageBucket: "vehiclecheckapp-3ca0e.firebasestorage.app",
  messagingSenderId: "788437414176",
  appId: "1:788437414176:web:af2746dd86f4aeed0c6745"
});

const auth = firebase.auth();
const db = firebase.firestore();

// Enable offline persistence
db.enablePersistence().catch(err => {
  if (err.code === 'failed-precondition') {
    console.log('Multiple tabs open, persistence only works in one tab');
  } else if (err.code === 'unimplemented') {
    console.log('Browser does not support offline mode');
  }
});

/* ================= DATA ================= */
let vehicles = [];
let vehiclesListener = null;
let currentUser = null;

/* ================= HELPERS ================= */
function parseDate(str){
  if(!str || !/^\d{2}\/\d{2}\/\d{2}$/.test(str)) return null;
  const [d,m,y] = str.split("/").map(Number);
  return new Date(2000+y, m-1, d);
}

function daysLeft(str){
  const d = parseDate(str);
  if(!d) return null;
  return Math.ceil((d - new Date()) / 86400000);
}

function remaining(days){
  if(days === null) return "—";
  if(days < 0) return "Expired";
  if(days <= 60) return days + " days";
  return Math.round(days/30) + " months";
}

function timeAgo(ts){
  if(!ts) return "";
  const s = Math.floor((Date.now() - ts) / 1000);
  if(s < 3600) return Math.floor(s/60) + " min ago";
  if(s < 86400) return Math.floor(s/3600) + " h ago";
  return Math.floor(s/86400) + " d ago";
}

/* ================= RENDER ================= */
const vehiclesEl = document.getElementById("vehicles");

function renderAll(){
  if(vehicles.length === 0) {
    vehiclesEl.innerHTML = '<div class="loading">No vehicles yet. Click + to add one!</div>';
    return;
  }
  vehiclesEl.innerHTML = vehicles.map(v => renderVehicle(v)).join("");
}

function renderVehicle(v){
  const taxDays = daysLeft(v.taxExpiry);
  const insDays = daysLeft(v.insuranceExpiry);

  function line(label, days){
    let cls = "";
    if(days !== null){
      if(days < 0) cls = "expired";
      else if(days <= 14) cls = "warn";
    }
    const value = remaining(days);
    return `<div class="meta-entry ${cls}"><div class="meta-label">${label}</div><div class="meta-value">${value}</div></div>`;
  }

  // Use vehicleType image from vehicletypes folder
  const type = v.vehicleType || "scooter";
  const typeImg = `vehicletypes/${type}.png`;

  return `
  <div class="card">
    <div class="card-header">
      <div class="name">${v.name || "Unnamed Vehicle"}</div>
      <div class="plate-right">${v.plate || ""}</div>
      <button class="btn" style="margin-left:8px;" onclick="openEditVehicleModal('${v.id}')">Edit</button>
    </div>

    <div class="row">
      <img src="${typeImg}" class="vehicle" onerror="this.style.display='none'">
      <div class="info">
        <div style="font-size:12px; color:#888; margin-bottom:2px;">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
        <div class="meta">
          ${line("Tax", taxDays)}
          ${line("Insurance", insDays)}
        </div>
      </div>
    </div>

    <div class="updated">
      ${v.updatedAt ? `${timeAgo(v.updatedAt)} by ${v.updatedBy||""}` : ""}
    </div>
  </div>`;
}

/* ================= FIRESTORE OPERATIONS ================= */
function loadUserVehicles(userId) {
  // Unsubscribe from previous listener if it exists
  if(vehiclesListener) {
    vehiclesListener();
  }

  // Set up real-time listener for user's vehicles
  vehiclesListener = db.collection("vehicles")
    .where("userId", "==", userId)
    .onSnapshot(snapshot => {
      vehicles = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        vehicles.push({
          id: doc.id,
          name: data.name || "Unnamed Vehicle",
          plate: data.plate || "",
          vehicleType: data.vehicleType || "scooter",
          taxExpiry: data.taxExpiry || "",
          insuranceExpiry: data.insuranceExpiry || "",
          createdAt: data.createdAt?.toMillis ? data.createdAt.toMillis() : Date.now(),
          updatedAt: data.updatedAt?.toMillis ? data.updatedAt.toMillis() : null,
          updatedBy: data.updatedBy || "",
          userId: data.userId
        });
      });
      // Sort by createdAt in JavaScript
      vehicles.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
      renderAll();
    }, err => {
      console.error("Error loading vehicles:", err);
      vehiclesEl.innerHTML = '<div class="loading">Error loading vehicles. Please try refreshing.</div>';
    });
}

/* ================= AUTH ================= */
const avatar = document.getElementById("avatar");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");

// Initial state
avatar.style.display = "none";
loginBtn.style.display = "inline-block";
logoutBtn.style.display = "none";

auth.onAuthStateChanged(user => {
  currentUser = user;
  
  if(user){
    avatar.src = user.photoURL || "";
    avatar.style.display = user.photoURL ? "block" : "none";
    loginBtn.style.display = "none";
    logoutBtn.style.display = "inline-block";
    
    // Load user's vehicles
    loadUserVehicles(user.uid);
  } else {
    avatar.style.display = "none";
    loginBtn.style.display = "inline-block";
    logoutBtn.style.display = "none";
    
    // Clear vehicles and listener
    if(vehiclesListener) {
      vehiclesListener();
      vehiclesListener = null;
    }
    vehicles = [];
    vehiclesEl.innerHTML = '<div class="loading">Please log in to view your vehicles</div>';
  }
});

/* ================= ACTIONS ================= */
function signIn(){ 
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); 
}

function signOut(){ 
  auth.signOut(); 
}

/* ================= ADD VEHICLE MODAL ================= */
function openAddVehicleModal() {
  if(!currentUser){
    alert("Please log in to add vehicles");
    signIn();
    return;
  }
  document.getElementById("addVehicleModal").classList.add("active");
  document.getElementById("vehicleName").value = "";
  document.getElementById("vehiclePlate").value = "";
  document.getElementById("vehicleType").value = "scooter";
  document.getElementById("addTaxExpiry").value = "";
  document.getElementById("addInsuranceExpiry").value = "";
  document.getElementById("vehicleName").focus();
}

function closeAddVehicleModal() {
  document.getElementById("addVehicleModal").classList.remove("active");
}

function addVehicle() {
  if(!currentUser) {
    alert("Please log in first");
    return;
  }

  const name = document.getElementById("vehicleName").value.trim();
  const plate = document.getElementById("vehiclePlate").value.trim();
  const vehicleType = document.getElementById("vehicleType").value || "scooter";
  const taxExpiry = document.getElementById("addTaxExpiry").value.trim();
  const insuranceExpiry = document.getElementById("addInsuranceExpiry").value.trim();

  if(!name) {
    alert("Please enter a vehicle name");
    return;
  }

  // Add to Firestore - all data in one document
  db.collection("vehicles").add({
    userId: currentUser.uid,
    name: name,
    plate: plate,
    vehicleType: vehicleType,
    taxExpiry: taxExpiry,
    insuranceExpiry: insuranceExpiry,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedBy: currentUser.displayName || currentUser.email || "User"
  }).then(() => {
    closeAddVehicleModal();
  }).catch(err => {
    alert("Error adding vehicle: " + err.message);
    console.error(err);
  });
}

/* ================= EDIT VEHICLE MODAL ================= */
let editingVehicleId = null;

function openEditVehicleModal(id) {
  if(!currentUser) {
    alert("Please log in to edit vehicles");
    return;
  }
  
  editingVehicleId = id;
  const v = vehicles.find(veh => veh.id === id);
  if (!v) return;
  
  document.getElementById("editVehicleName").value = v.name || "";
  document.getElementById("editVehiclePlate").value = v.plate || "";
  document.getElementById("editVehicleType").value = v.vehicleType || "scooter";
  document.getElementById("editTaxExpiry").value = v.taxExpiry || "";
  document.getElementById("editInsuranceExpiry").value = v.insuranceExpiry || "";
  document.getElementById("editVehicleModal").classList.add("active");
}

function closeEditVehicleModal() {
  document.getElementById("editVehicleModal").classList.remove("active");
  editingVehicleId = null;
}

function saveEditVehicle() {
  if (!editingVehicleId || !currentUser) return;
  
  const name = document.getElementById("editVehicleName").value.trim();
  const plate = document.getElementById("editVehiclePlate").value.trim();
  const vehicleType = document.getElementById("editVehicleType").value;
  const taxExpiry = document.getElementById("editTaxExpiry").value.trim();
  const insuranceExpiry = document.getElementById("editInsuranceExpiry").value.trim();

  if(!name) {
    alert("Please enter a vehicle name");
    return;
  }

  // Update all fields in Firestore
  db.collection("vehicles").doc(editingVehicleId).update({
    name: name,
    plate: plate,
    vehicleType: vehicleType,
    taxExpiry: taxExpiry,
    insuranceExpiry: insuranceExpiry,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedBy: currentUser.displayName || currentUser.email || "User"
  }).then(() => {
    closeEditVehicleModal();
  }).catch(err => {
    alert("Error updating vehicle: " + err.message);
    console.error(err);
  });
}

function deleteVehicle() {
  if (!editingVehicleId) return;
  if (!confirm("Are you sure you want to delete this vehicle?")) return;
  
  db.collection("vehicles").doc(editingVehicleId).delete()
    .then(() => {
      closeEditVehicleModal();
    })
    .catch(err => {
      alert("Error deleting vehicle: " + err.message);
      console.error(err);
    });
}

// Close modals when clicking outside
document.addEventListener('click', function(e) {
  const addModal = document.getElementById("addVehicleModal");
  const editModal = document.getElementById("editVehicleModal");
  
  if(e.target === addModal) {
    closeAddVehicleModal();
  }
  if(e.target === editModal) {
    closeEditVehicleModal();
  }
});

// Close modals on Escape key
document.addEventListener('keydown', function(e) {
  if(e.key === 'Escape') {
    closeAddVehicleModal();
    closeEditVehicleModal();
  }
});
</script>

</body>
</html>